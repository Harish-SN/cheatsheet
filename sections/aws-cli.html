<h2>AWS CLI</h2>
<p>Profiles/STS/IAM and one-liners for EC2, S3, DynamoDB, Lambda, AppSync (GraphQL), ECR, and EKS.</p>
<div class="grid">

    <!-- Setup -->
    <details open>
        <summary>Install & Configure</summary>
        <div class="code">
            <button class="copy" data-target="awscli-setup">Copy</button>
            <pre id="awscli-setup"><code># Linux install
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
unzip awscliv2.zip && sudo ./aws/install

# Configure default & named profile
aws configure
aws configure --profile dev

# SSO (IAM Identity Center)
aws configure sso --profile dev
aws sso login --profile dev

# Use profile/region
export AWS_PROFILE=dev
export AWS_REGION=ap-south-1
</code></pre>
        </div>
    </details>

    <!-- STS/IAM -->
    <details>
        <summary>STS & IAM</summary>
        <div class="code">
            <button class="copy" data-target="awscli-sts-iam">Copy</button>
            <pre id="awscli-sts-iam"><code># Who am I?
aws sts get-caller-identity

# Assume role (prints temporary creds)
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/Admin \
  --role-session-name cli \
  --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
  --output text

# IAM quick refs
aws iam list-users --output table
aws iam list-roles  --output table
aws iam attach-user-policy \
  --user-name alice \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
</code></pre>
        </div>
    </details>

    <!-- EC2 -->
    <details>
        <summary>EC2</summary>
        <div class="code">
            <button class="copy" data-target="awscli-ec2">Copy</button>
            <pre id="awscli-ec2"><code># List instances (table)
aws ec2 describe-instances \
  --query "Reservations[].Instances[].{Id:InstanceId,State:State.Name,Type:InstanceType,IP:PublicIpAddress,Name:Tags[?Key=='Name']|[0].Value}" \
  --output table

# Start/Stop/Terminate
aws ec2 start-instances --instance-ids i-0123456789abcdef0
aws ec2 stop-instances  --instance-ids i-0123456789abcdef0
aws ec2 terminate-instances --instance-ids i-0123456789abcdef0

# SG open HTTP (80) to world (demo!)
aws ec2 authorize-security-group-ingress \
  --group-id sg-0123456789abcdef0 \
  --protocol tcp --port 80 --cidr 0.0.0.0/0

# Latest Amazon Linux 2023 AMI
aws ssm get-parameters --names /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64 \
  --query "Parameters[0].Value" --output text
</code></pre>
        </div>
    </details>

    <!-- S3 -->
    <details>
        <summary>S3</summary>
        <div class="code">
            <button class="copy" data-target="awscli-s3">Copy</button>
            <pre id="awscli-s3"><code># Buckets
aws s3 ls
aws s3 mb s3://my-bucket

# Upload/Download/Sync
aws s3 cp file.txt s3://my-bucket/file.txt
aws s3 cp s3://my-bucket/file.txt .
aws s3 sync ./public s3://my-bucket --delete

# Public ACL (needs bucket policy)
aws s3api put-object-acl --bucket my-bucket --key index.html --acl public-read

# Presign
aws s3 presign s3://my-bucket/file.txt --expires-in 3600
</code></pre>
        </div>
    </details>

    <!-- DynamoDB -->
    <details>
        <summary>DynamoDB</summary>
        <div class="code">
            <button class="copy" data-target="awscli-ddb">Copy</button>
            <pre id="awscli-ddb"><code># Create table (PK only, on-demand)
aws dynamodb create-table \
  --table-name Users \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST

# Put/Get
aws dynamodb put-item \
  --table-name Users \
  --item '{"id":{"S":"u#1"},"name":{"S":"Alice"}}'

aws dynamodb get-item \
  --table-name Users \
  --key '{"id":{"S":"u#1"}}' --consistent-read

# Query PK (+ SK range if defined)
aws dynamodb query \
  --table-name Orders \
  --key-condition-expression "userId = :u" \
  --expression-attribute-values '{":u":{"S":"u#1"}}'

# TTL / Streams
aws dynamodb update-time-to-live --table-name Users \
  --time-to-live-specification "Enabled=true,AttributeName=expireAt"

aws dynamodb update-table --table-name Users \
  --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
</code></pre>
        </div>
    </details>

    <!-- Lambda -->
    <details>
        <summary>Lambda</summary>
        <div class="code">
            <button class="copy" data-target="awscli-lambda">Copy</button>
            <pre id="awscli-lambda"><code># Create from zip (Node.js 18)
zip -r func.zip index.mjs node_modules
aws lambda create-function \
  --function-name my-func \
  --runtime nodejs18.x \
  --role arn:aws:iam::123456789012:role/lambda-basic-exec \
  --handler index.mjs \
  --zip-file fileb://func.zip

# Update code & config
aws lambda update-function-code --function-name my-func --zip-file fileb://func.zip
aws lambda update-function-configuration --function-name my-func --timeout 15 --memory-size 512

# Invoke & logs
aws lambda invoke --function-name my-func --payload '{"ping":1}' out.json && cat out.json
aws logs tail /aws/lambda/my-func --follow --since 10m
</code></pre>
        </div>
    </details>

    <!-- AppSync -->
    <details>
        <summary>AppSync (GraphQL)</summary>
        <div class="code">
            <button class="copy" data-target="awscli-appsync">Copy</button>
            <pre id="awscli-appsync"><code># List GraphQL APIs
aws appsync list-graphql-apis \
  --query "graphqlApis[].{Id:apiId,Name:name,Uri:uris.GRAPHQL}" --output table

# Get API details
aws appsync get-graphql-api --api-id abcdef123456

# API Keys (for API key auth)
aws appsync list-api-keys   --api-id abcdef123456
aws appsync create-api-key  --api-id abcdef123456 --expires 1700000000

# Download introspection schema
aws appsync get-introspection-schema \
  --api-id abcdef123456 --format JSON schema.json
</code></pre>
        </div>
    </details>

    <!-- ECR -->
    <details>
        <summary>ECR (Images & Registries)</summary>
        <div class="code">
            <button class="copy" data-target="awscli-ecr-login">Copy</button>
            <pre id="awscli-ecr-login"><code># Login (private ECR)
aws ecr get-login-password --region ap-south-1 | \
  docker login --username AWS --password-stdin 123456789012.dkr.ecr.ap-south-1.amazonaws.com

# Create repo (idempotent)
aws ecr describe-repositories --repository-names app || \
aws ecr create-repository --repository-name app

# Build / tag / push
ACCOUNT_ID=123456789012
REGION=ap-south-1
REPO=app
IMG_URI=${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:v1

docker build -t ${REPO}:v1 .
docker tag ${REPO}:v1 ${IMG_URI}
docker push ${IMG_URI}
</code></pre>
        </div>

        <div class="code">
            <button class="copy" data-target="awscli-ecr-scan-lc">Copy</button>
            <pre id="awscli-ecr-scan-lc"><code># Enable scan on push
aws ecr put-image-scanning-configuration \
  --repository-name app --image-scanning-configuration scanOnPush=true

# Start scan & show findings
aws ecr start-image-scan --repository-name app --image-id imageTag=v1
aws ecr describe-image-scan-findings --repository-name app --image-id imageTag=v1

# Lifecycle policy: keep last 10
cat > lc.json <<'JSON'
{
  "rules": [{
    "rulePriority": 1,
    "description": "keep last 10",
    "selection": {"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},
    "action": {"type":"expire"}
  }]
}
JSON
aws ecr put-lifecycle-policy --repository-name app --lifecycle-policy-text file://lc.json
</code></pre>
        </div>

        <div class="code">
            <button class="copy" data-target="awscli-ecr-policy">Copy</button>
            <pre id="awscli-ecr-policy"><code># Cross-account pull policy
cat > policy.json <<'JSON'
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowCrossAccountPull",
    "Effect": "Allow",
    "Principal": {"AWS": "arn:aws:iam::111122223333:root"},
    "Action": ["ecr:BatchGetImage","ecr:GetDownloadUrlForLayer"]
  }]
}
JSON
aws ecr set-repository-policy --repository-name app --policy-text file://policy.json

# Cleanup
aws ecr list-images --repository-name app --query 'imageIds[*]' --output json > imgs.json
aws ecr batch-delete-image --repository-name app --image-ids file://imgs.json
aws ecr delete-repository --repository-name app --force
</code></pre>
        </div>

        <div class="code">
            <button class="copy" data-target="awscli-ecr-public">Copy</button>
            <pre id="awscli-ecr-public"><code># Public ECR login
aws ecr-public get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin public.ecr.aws

# Create public repo & push
aws ecr-public create-repository --repository-name app-public
PUB_URI=public.ecr.aws/abcd1234/app-public:latest
docker tag app:latest ${PUB_URI}
docker push ${PUB_URI}
</code></pre>
        </div>
    </details>

    <!-- EKS -->
    <details>
        <summary>EKS</summary>
        <div class="code">
            <button class="copy" data-target="awscli-eks">Copy</button>
            <pre id="awscli-eks"><code># Update kubeconfig (use kubectl afterward)
aws eks update-kubeconfig --name demo-cluster --region ap-south-1

# Verify
kubectl get nodes
kubectl get ns

# OIDC provider (for IRSA)
eksctl utils associate-iam-oidc-provider --cluster demo-cluster --approve

# Describe cluster
aws eks describe-cluster --name demo-cluster --query "cluster.status"
</code></pre>
        </div>
    </details>

    <!-- Handy -->
    <details>
        <summary>Handy Commands</summary>
        <div class="code">
            <button class="copy" data-target="awscli-handy">Copy</button>
            <pre id="awscli-handy"><code># Regions / Profiles
aws ec2 describe-regions --all-regions --output table
aws configure list-profiles

# CloudWatch
aws logs describe-log-groups
aws logs tail /aws/lambda/my-func --since 1h --follow
</code></pre>
        </div>
    </details>

</div>