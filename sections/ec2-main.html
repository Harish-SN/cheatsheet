<h2>EC2 Maintenance</h2>
<p>Start/stop/reboot, resize instance type, EBS & filesystem expansion, snapshots & AMIs, security & patching (SSM), and
    health checks for EC2.</p>
<div class="grid">

    <!-- Start / Stop / Reboot -->
    <details open>
        <summary>Start / Stop / Reboot</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-startstop">Copy</button>
            <pre id="ec2-maintain-startstop"><code># Start / Stop / Reboot an instance
aws ec2 start-instances --instance-ids i-1234567890abcdef0
aws ec2 stop-instances  --instance-ids i-1234567890abcdef0
aws ec2 reboot-instances --instance-ids i-1234567890abcdef0

# Current status (includes status checks)
aws ec2 describe-instance-status \
  --instance-ids i-1234567890abcdef0 --include-all-instances

# Public DNS / IP quick view
aws ec2 describe-instances --instance-ids i-1234567890abcdef0 \
  --query "Reservations[0].Instances[0].[PublicDnsName,PublicIpAddress,PrivateIpAddress]" \
  --output table</code></pre>
        </div>
    </details>

    <!-- Resize Instance Type -->
    <details>
        <summary>Resize Instance Type (stop → modify → start)</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-resize">Copy</button>
            <pre id="ec2-maintain-resize"><code># Stop instance before changing type
aws ec2 stop-instances --instance-ids i-1234567890abcdef0

# Change to, e.g., t3.large (verify AZ supports it)
aws ec2 modify-instance-attribute \
  --instance-id i-1234567890abcdef0 \
  --instance-type "{\"Value\":\"t3.large\"}"

# Start instance again
aws ec2 start-instances --instance-ids i-1234567890abcdef0

# Verify type
aws ec2 describe-instances --instance-ids i-1234567890abcdef0 \
  --query "Reservations[0].Instances[0].InstanceType"</code></pre>
        </div>
    </details>

    <!-- EBS & Filesystem expand -->
    <details>
        <summary>Expand EBS Volume + Grow Filesystem</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-ebs-grow">Copy</button>
            <pre id="ec2-maintain-ebs-grow"><code># 1) Find root volume id from instance
aws ec2 describe-instances --instance-ids i-1234567890abcdef0 \
  --query "Reservations[0].Instances[0].BlockDeviceMappings[?DeviceName=='/dev/xvda'].Ebs.VolumeId" --output text

# 2) Modify size (e.g., 100 GiB)
VOL_ID=vol-12345678
aws ec2 modify-volume --volume-id $VOL_ID --size 100

# Wait until the volume optimization is done (optional)
aws ec2 describe-volumes-modifications --volume-id $VOL_ID --query "VolumesModifications[0].ModificationState"

# 3) On the instance (Amazon Linux with xfs on /dev/xvda1)
# Check partitions & filesystem
lsblk
df -h

# Grow partition if needed (root often xvda1)
sudo growpart /dev/xvda 1

# If XFS (Amazon Linux default), grow filesystem:
sudo xfs_growfs -d /

# If ext4 instead:
# sudo resize2fs /dev/xvda1</code></pre>
        </div>
    </details>

    <!-- Attach / Detach extra EBS -->
    <details>
        <summary>Attach / Detach Extra EBS Volume</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-ebs-attach">Copy</button>
            <pre id="ec2-maintain-ebs-attach"><code># Create 20GiB gp3 volume in same AZ as instance
aws ec2 create-volume --availability-zone ap-south-1a --size 20 --volume-type gp3

# Attach to instance (example device /dev/sdf → shows as /dev/xvdf)
aws ec2 attach-volume --volume-id vol-12345678 --instance-id i-1234567890abcdef0 --device /dev/sdf

# On instance: make filesystem & mount
sudo lsblk
sudo mkfs -t xfs /dev/xvdf
sudo mkdir -p /data
sudo mount /dev/xvdf /data

# Persist mount (add to /etc/fstab)
# echo "/dev/xvdf  /data  xfs  defaults,nofail  0  2" | sudo tee -a /etc/fstab

# Detach (unmount first!)
sudo umount /data
aws ec2 detach-volume --volume-id vol-12345678</code></pre>
        </div>
    </details>

    <!-- Snapshots & AMIs -->
    <details>
        <summary>Snapshots & AMIs (backup/rollback)</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-snapshots">Copy</button>
            <pre id="ec2-maintain-snapshots"><code># Snapshot a volume
aws ec2 create-snapshot --volume-id vol-12345678 --description "pre-maintenance"

# List my snapshots
aws ec2 describe-snapshots --owner-ids self --query "Snapshots[].[StartTime,SnapshotId,VolumeId,State]" --output table

# Create AMI from instance (no-reboot to avoid downtime)
aws ec2 create-image \
  --instance-id i-1234567890abcdef0 \
  --name "webserver-ami-$(date +%Y%m%d-%H%M)" \
  --no-reboot

# Deregister AMI & delete snapshot (cleanup old backups)
aws ec2 deregister-image --image-id ami-1234567890abcdef0
aws ec2 delete-snapshot --snapshot-id snap-1234567890abcdef0</code></pre>
        </div>
    </details>

    <!-- Amazon Linux (dnf) updates -->
    <details>
        <summary>Manual Updates (Amazon Linux with dnf)</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-dnf">Copy</button>
            <pre id="ec2-maintain-dnf"><code># SSH in
ssh -i ~/.ssh/key.pem ec2-user@ec2-xx-xx-xx-xx.compute.amazonaws.com

# Update metadata & view pending
sudo dnf check-update

# Upgrade all packages (security + bugfix)
sudo dnf upgrade -y

# Kernel/security (ensure kernel picks up)
sudo dnf update -y kernel*

# Clean unused and cache
sudo dnf autoremove -y
sudo dnf clean all

# Reboot if kernel/glibc updated
sudo reboot</code></pre>
        </div>
    </details>

    <!-- SSM Patch / RunCommand -->
    <details>
        <summary>Automated Patching (SSM Patch Manager / RunCommand)</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-ssm">Copy</button>
            <pre id="ec2-maintain-ssm"><code># Apply Patch Baseline immediately (instance must have SSM agent + role)
aws ssm send-command \
  --targets "Key=instanceIds,Values=i-1234567890abcdef0" \
  --document-name "AWS-RunPatchBaseline" \
  --comment "Apply security updates" \
  --parameters '{"Operation":["Install"]}'

# Run ad-hoc shell command
aws ssm send-command \
  --targets "Key=instanceIds,Values=i-1234567890abcdef0" \
  --document-name "AWS-RunShellScript" \
  --parameters '{"commands":["sudo dnf upgrade -y","sudo reboot"]}'</code></pre>
        </div>
    </details>

    <!-- Security Groups & Elastic IP -->
    <details>
        <summary>Security Groups & Elastic IP</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-sg-eip">Copy</button>
            <pre id="ec2-maintain-sg-eip"><code># List security groups
aws ec2 describe-security-groups --query "SecurityGroups[].[GroupId,GroupName,VpcId]" --output table

# Allow SSH (22) from your IP
MYIP=$(curl -s https://checkip.amazonaws.com)/32
aws ec2 authorize-security-group-ingress --group-id sg-12345678 \
  --protocol tcp --port 22 --cidr $MYIP

# Allocate & associate Elastic IP
EIP_ALLOC=$(aws ec2 allocate-address --domain vpc --query AllocationId --output text)
aws ec2 associate-address --instance-id i-1234567890abcdef0 --allocation-id $EIP_ALLOC

# Disassociate & release when done
# aws ec2 disassociate-address --association-id eipassoc-abc...
# aws ec2 release-address --allocation-id $EIP_ALLOC</code></pre>
        </div>
    </details>

    <!-- Status / Diagnostics -->
    <details>
        <summary>Status Checks & Diagnostics</summary>
        <div class="code">
            <button class="copy" data-target="ec2-maintain-health">Copy</button>
            <pre
                id="ec2-maintain-health"><code># Instance & system status
aws ec2 describe-instance-status --instance-ids i-1234567890abcdef0 \
  --query "InstanceStatuses[0].{Instance:InstanceStatus.Status,System:SystemStatus.Status}" --output table

# Console output (helpful after failed boots)
aws ec2 get-console-output --instance-id i-1234567890abcdef0 --latest

# Screenshot of console (UEFI/graphics boot)
aws ec2 get-console-screenshot --instance-id i-1234567890abcdef0 --wake-up \
  --output text > console.png

# Network interfaces
aws ec2 describe-network-interfaces --filters Name=attachment.instance-id,Values=i-1234567890abcdef0 \
  --query "NetworkInterfaces[].{Id:NetworkInterfaceId,PrivateIp:PrivateIpAddress,Status:Status}" --output table</code></pre>
        </div>
    </details>

</div>